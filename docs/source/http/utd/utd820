
Работа с документами в 820 формате
==================================

`Приказом ФНС России от 19.12.2018 №ММВ-7-15/820@ <https://normativ.kontur.ru/document?moduleId=1&documentId=328588>`_ утвержден новый формат электронных докуменов, который можно использовать как:

- счет-фактуру;

- первичный документ, подтверждающий совершение хозяйственной операции;

- универсальный передаточный документ (УПД), который совмещает в себе счет-фактуру и первичный документ, подтверждающий совершение хозяйственной операции.

.. note::
    Форма универсального передаточного документа, а также рекомендации по его заполнению приведены в письме ФНС России `от 21.10.13 № ММВ-20-3/96@ <https://normativ.kontur.ru/document?moduleId=1&documentId=220334>`__.
    
Рассмотрим на примере УПД сценарий работы с документами 820 формата. Методы и подходы, описанные ниже, можно использовать также для работы с накладными, актами и счетами-фактурами в 820 формате.

Сценарий включает в себя следующие шаги:

#. Продавец:
- генерирует титул продавца,
- отправляет его покупателю.
#. Покупатель:
- парсит титул продавца, 
- генерирует титул покупателя,
- отправляет его продавцу.

Генерация титула продавца
-------------------------

Для генерации необходимо использовать один из универсальных методов генерации - :http:`GenerateSenderTitleXml` или :http:`GenerateTitleXml`.

В теле запроса должен содержаться упрощенный XML-файл, соответствующий XSD-схеме контракта для генерации титула. XSD-схема контракта, необходимого для генерации титула, может быть получена с помощью ссылки, доступной в поле UserDataXsdUrl контракта :doc:`DocumentTitle <../proto/DocumentTypeDescription>`, который можно получить с помощью метода-справочника :doc:`GetDocumentTypes`.

Вызовем метод :doc:`GetDocumentTypes` и найдем интересующие нас тип-функцию верси. Для УПД в 820 формате возьмем следующие значения:
- TypeNamedId - UniversalTransferDocument
- Function - СЧФДОП
- Version - utd820_05_01_01_hyphen
- IndexTitle=0 (титул продавца)

*Ответ метода GetDocumentTypes*:

.. sourcecode:: json

 "Name": "UniversalTransferDocument",
 "Title": "УПД",
 "SupportedDocflows": [
    "External"
 ],
 "RequiresFnsRegistration": true,
 "Functions": [
    {
        "Name": "СЧФДОП",
        "Versions": [
            {
                "Version": "utd820_05_01_01_hyphen",
                "SupportsContentPatching": true,
                "SupportsEncrypting": true,
                "Titles": [
                    {
                        "Index": 0,
                        "IsFormal": true,
                        "XsdUrl": "/GetContent?typeNamedId=UniversalTransferDocument&function=%u0421%u0427%u0424%u0414%u041e%u041f&version=utd820_05_01_01_hyphen&titleIndex=0&contentType=TitleXsd",
                        "UserDataXsdUrl": "/GetContent?typeNamedId=UniversalTransferDocument&function=%u0421%u0427%u0424%u0414%u041e%u041f&version=utd820_05_01_01_hyphen&titleIndex=0&contentType=UserContractXsd",
                         "SignerInfo": {
                            "SignerType": "ExtendedSigner",
                            "ExtendedDocumentTitleType": "UtdSeller"
                         },
                          "MetadataItems": [...],
                           "EncryptedMetadataItems": [...],
                           "IsActual": true,
                            "Workflows": [
                                {
                                    "Id": 10,
                                    "IsDefault": true
                                }
                            ],
                            "SupportsPredefinedRecipientTitle": false
                        }
                     }
                  ]
               }
            ]
         }
      ]
   ]
 

Теперь нужно подготовить контент для титула. Титул — это xml-файл, соответствующий xsd-схеме. Часть данных в титуле может быть заполнена только пользователем — это информация о товарах, услугах и т.д. А часть данных может быть заполнена автоматически на основании формата и информации в Диадоке. Например, заполнить реквизиты организации продавца и покупателя по идентификатору ящика, установить значения КНД, версии формата, версии программы и т.д. Для упрощения генерации, Диадок позволяет заполнить только «пользовательский» xml-файл, он же UserDataXml. На базе UserDataXml метод генерации сформирует основной титул, дополнив его всеми необходимыми данными согласно xsd-схеме.

Общая схема работы:

.. image:: ../_static/img/diadoc-api-generate-xml-schema1.png
    :align: center

Выбор, как формировать UserDataXml, остаётся за разработчиком интеграционного решения.

Один из путей — это кодогенерация из xsd-схемы упрощённого титула. Ссылка на схему находится в поле UserDataXsdUrl из выдачи GetDocumentTypes выше.

В качестве примера, в C# SDK для всех версий формата приказа №820 есть `пример кодогенерации <https://github.com/diadoc/diadocsdk-csharp/tree/master/src/DataXml>`_. 

Кодогенерация осуществлена `инструментом xsd.exe <https://docs.microsoft.com/ru-ru/dotnet/standard/serialization/xml-schema-definition-tool-xsd-exe>`_.

Чтобы воспользоваться ей в C#-клиенте, достаточно заполнить объект UniversalTransferDocument для титула отправителя (или UniversalTransferDocumentBuyerTitle для титула получателя) и затем `сериализовать в XML <https://github.com/diadoc/diadocsdk-csharp/blob/master/src/XmlSerializerExtensions.cs>`_.


Итого, имея идентификаторы типа, функции, версии, порядкового номера титула, а также пользовательский контент, можем получить сам титул счёта-фактуры.

*Пример http-запроса*:

.. sourcecode:: http

    POST /GenerateTitleXml?boxId=a96be310-0982-461a-8b2a-91d198b7861c&documentTypeNamedId=UniversalTransferDocument&documentFunction=СЧФДОП&documentVersion=utd820_05_01_01_hyphen&titleIndex=0 HTTP/1.1
    Host: diadoc-api.kontur.ru
    Authorization: DiadocAuth ddauth_api_client_id={{ключ разработчика}}, ddauth_token={{авторизационный токен}}
    Content-Type: application/xml; charset=utf-8


*Пример UserDataXml (тело запроса)*:

.. sourcecode:: xml

   <?xml version="1.0" encoding="utf-8"?>
   <UniversalTransferDocument Function="СЧФДОП"
                              DocumentDate="01.08.2019"
                              DocumentNumber="140"
                              DocumentCreator="1"
                              DocumentCreatorBase="1"
                              CircumFormatInvoice="1"
                              Currency="643">
       <Sellers>
           <Seller>
               <OrganizationDetails OrgType="2"
                                    Inn="114500647890"
                                    FnsParticipantId="2BM-participantId1"
                                    OrgName="ИП Продавец Иван Иванович">
                   <Address>
                       <RussianAddress Region="02"/>
                   </Address>
               </OrganizationDetails>
           </Seller>
       </Sellers>
       <Buyers>
           <Buyer>
               <OrganizationReference OrgType="1"
                                      BoxId="74ef3a00-c625-3ef0-9b50-65bf7f96b9ae"/>
           </Buyer>
       </Buyers>
       <Table TotalWithVatExcluded="0" Vat="0" Total="0">
           <Item Product="Товарная позиция"
                 Unit="796"
                 Quantity="0"
                 Price="0"
                 TaxRate="без НДС"
                 SubtotalWithVatExcluded="0"
                 Vat="0"
                 Subtotal="0"/>
       </Table>
       <TransferInfo OperationInfo="Товары переданы"/>
       <Signers>
           <SignerDetails Inn="123456789047"
                          LastName="Подписантов"
                          FirstName="Иван"
                          MiddleName="Иванович"
                          RegistrationCertificate="1"
                          SignerPowers="0"
                          SignerType="3"
                          SignerStatus="1"
                          SignerPowersBase="Должностные обязанности"/>
       </Signers>
   </UniversalTransferDocument>



*Пример получившегося титула (тело ответа)*:

.. sourcecode:: xml

<?xml version="1.0" encoding="windows-1251"?>
<Файл ИдФайл="ON_NSCHFDOPPR_2BM-7750370234-4012052808304878702630000000000_2BM-participantId1_20191011_2ebfc880-6e31-4042-8302-c5201523fc3c" ВерсФорм="5.01" ВерсПрог="Diadoc 1.0">
   <СвУчДокОбор ИдОтпр="2BM-participantId1" ИдПол="2BM-7750370234-4012052808304878702630000000000">
      <СвОЭДОтпр ИННЮЛ="6663003127" ИдЭДО="2BM" НаимОрг="АО &quot;ПФ &quot;СКБ Контур&quot;" />
   </СвУчДокОбор>
   <Документ КНД="1115131" ВремИнфПр="15.49.07" ДатаИнфПр="11.10.2019" НаимЭконСубСост="1" Функция="СЧФДОП" ПоФактХЖ="Документ об отгрузке товаров (выполнении работ), передаче имущественных прав (документ об оказании услуг)" НаимДокОпр="Счет-фактура и документ об отгрузке товаров (выполнении работ), передаче имущественных прав (документ об оказании услуг)" ОснДоверОргСост="1">
   <СвСчФакт НомерСчФ="140" ДатаСчФ="01.08.2019" КодОКВ="643">
      <СвПрод>
         <ИдСв>
            <СвИП ИННФЛ="114500647890">
               <ФИО Фамилия="Продавец" Имя="Иван" Отчество="Иванович" />
            </СвИП>
         </ИдСв>
         <Адрес>
            <АдрРФ КодРегион="02" />
         </Адрес>
      </СвПрод>
      <СвПокуп>
         <СвИП ИННФЛ="114500647890">
            <ФИО Фамилия="Покупатель" Имя="Иван" Отчество="Иванович" />
         </СвИП>
         <Адрес>
            <АдрРФ КодРегион="66" Индекс="620000" Город="Екатеринбург г" Улица="Радищева" />
         </Адрес>
      </СвПокуп>
      <ДопСвФХЖ1 НаимОКВ="Российский рубль" ОбстФормСЧФ="1" />
   </СвСчФакт>
   <ТаблСчФакт>
      <СведТов НомСтр="1" НаимТов="Товарная позиция" ОКЕИ_Тов="796" КолТов="0" ЦенаТов="0" СтТовБезНДС="0.00" НалСт="без НДС" СтТовУчНал="0.00">
         <Акциз>
            <БезАкциз>без акциза</БезАкциз>
         </Акциз>
         <СумНал>
            <СумНал>0.00</СумНал>
         </СумНал>
         <ДопСведТов НаимЕдИзм="шт" />
      </СведТов>
      <ВсегоОпл СтТовБезНДСВсего="0.00" СтТовУчНалВсего="0.00">
         <СумНалВсего>
            <СумНал>0.00</СумНал>
         </СумНалВсего>
      </ВсегоОпл>
   </ТаблСчФакт>
   <СвПродПер>
      <СвПер СодОпер="Товары переданы">
         <ОснПер НаимОсн="Без документа-основания" />
      </СвПер>
   </СвПродПер>
   <Подписант ОснПолн="Должностные обязанности" ОблПолн="0" Статус="1">
      <ФЛ ИННФЛ="123456789047">
         <ФИО Фамилия="Подписантов" Имя="Иван" Отчество="Иванович" />
      </ФЛ>
   </Подписант>
</Документ>
</Файл>
